{{- if .Values.global.bigid.correlator.autoscaling.enabled -}}
{{- if $.Capabilities.APIVersions.Has "keda.sh/v1alpha1" }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: bigid-corr-new
  labels:
    deploymentName: bigid-corr-new
  annotations:
    scaledobject.keda.sh/transfer-hpa-ownership: "true"
  namespace: {{ .Release.Namespace | quote }}
spec:
  advanced:
    horizontalPodAutoscalerConfig:
      name: bigid-corr-new
      behavior:
        scaleDown:
          stabilizationWindowSeconds: {{ .Values.global.bigid.correlator.autoscaling.scaleDownPolicy.stabilizationWindowSeconds }}
          policies:
          - type: Percent
            value: {{ .Values.global.bigid.correlator.autoscaling.scaleDownPolicy.value }}
            periodSeconds: {{ .Values.global.bigid.correlator.autoscaling.scaleDownPolicy.periodSeconds }}
  maxReplicaCount: {{ .Values.global.bigid.correlator.autoscaling.maxReplicas }}
  minReplicaCount: {{ .Values.global.bigid.correlator.autoscaling.minReplicas }}
  pollingInterval: 30
  cooldownPeriod:  {{ .Values.global.bigid.correlator.autoscaling.scaleDownPolicy.stabilizationWindowSeconds }}
  scaleTargetRef:
    name: bigid-corr-new
  triggers:
    - type: rabbitmq
      metadata:
        mode: QueueLength # QueueLength or MessageRate
        value: {{ .Values.global.bigid.correlator.autoscaling.averageValue | quote }} # message backlog or publish/sec. target per instance
        queueName: ^(correlator.correlation.queue|correlator.classification.queue)$
        useRegex: "true"
        vhostName: /
        timeout: "120"
      authenticationRef:
        name: bigid-corr-new-trigger-auth
{{- end }}
{{- end }}
